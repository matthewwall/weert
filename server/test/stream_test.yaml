---
- config:
    - testset: "Test of streams API"

- test:
    - name: "Create a stream without Content-type"
    - url: "/api/v1/streams"
    - method: "POST"
    - body: '{"name" : "Test stream", "description" : "Created to test streams API", "join": "join_keyword", "name": "Stream nickname"}'
    - expected_status: [415]

- test:
    - name: "Create a stream"
    - url: "/api/v1/streams"
    - method: "POST"
    - body: '{"name" : "Test stream", "description" : "Created to test streams API", "join": "join_keyword", "name": "Stream nickname"}'
    - headers: {Content-Type: application/json}
    - expected_status: [201]
    - extract_binds:
        - 'streamID1': {'jsonpath_mini': '_id'}
        - 'URI1'    : {header: "Location"}

- test:
    - name: "Get the stream just created, and validate it"
    - url: {'template': "/api/v1/streams/$streamID1/"}
    - expected_status: [200]
    - validators:
        - compare: {jsonpath_mini: '_id', comparator: 'str_eq', expected: {template: '$streamID1'}}
        - compare: {jsonpath_mini: 'name', comparator: 'str_eq', expected: "Stream nickname"}
        - compare: {jsonpath_mini: 'join', comparator: 'str_eq', expected: "join_keyword"}

- test:
    - name: "Return a non-existent stream"
    - url: "/api/v1/streams/563e70fb5ebf66aa2e0ea7ee"
    - expected_status: [200]
    - validators:
        - compare: {raw_body: "", expected: 'null'}

- test:
    - name: "Return a stream with a malformed streamID"
    - url: "/api/v1/streams/foo"
    - expected_status: [400]

- test:
    - name: "Create another stream"
    - url: "/api/v1/streams"
    - method: "POST"
    - body: '{"name" : "Test stream 2", "description" : "Created a 2nd stream to test streams API", "join": "join_keyword2", "name": "Stream nickname2"}'
    - headers: {Content-Type: application/json}
    - expected_status: [201]
    - extract_binds:
        - 'streamID2': {'jsonpath_mini': '_id'}
        - 'URI2'    : {header: "Location"}

- test:
    - name: "Get all created streams and validate them"
    - url: {'template': "/api/v1/streams"}
    - expected_status: [200]
    - validators:
        - compare: {jsonpath_mini: '0', comparator: 'str_eq', expected: {template: '$URI1'}}
        - compare: {jsonpath_mini: '1', comparator: 'str_eq', expected: {template: '$URI2'}}


